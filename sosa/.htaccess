######################################################################
# Rewrite rules for the SOSA ontology, the SOSA to OBOE and the SOSA
# to O&M alignments.
#
# Ontologies and rules developed by the Spatial Data on the Web WG.
######################################################################

RewriteEngine On
RewriteBase  /ns/sosa/


######################################################################
# Disable content negotiation for om and oboe files
# (we'll use custom rewrite rules)
######################################################################
Options -MultiViews


######################################################################
# File-specific headers
# 
# Set the Content-Disposition HTTP header to improve "save as" dialogs
# and the Content-Location HTTP header when an internal redirect
# occurred.
#
# Note the Content-Type directive is probably useless since our server
# should already return the right one based on the file extension.
######################################################################
<Files ~ "sosa\.rdf$">
    Header set Content-Type "application/rdf+xml"
    Header set Content-Disposition "inline; filename= sosa.rdf"
    Header set Content-Location "http://www.w3.org/ns/sosa/sosa.rdf" env=REDIRECT_redirect
</Files>

<Files ~ "sosa\.ttl$">
    Header set Content-Type "text/turtle"
    Header set Content-Disposition "inline; filename= sosa.ttl"
    Header set Content-Location "http://www.w3.org/ns/sosa/sosa.ttl" env=REDIRECT_redirect
</Files>

<Files ~ "om\.rdf$">
    Header set Content-Type "application/rdf+xml"
    Header set Content-Disposition "inline; filename= sosa-om.rdf"
    Header set Content-Location "http://www.w3.org/ns/sosa/om.rdf" env=REDIRECT_redirect
</Files>

<Files ~ "om\.ttl$">
    Header set Content-Type "text/turtle"
    Header set Content-Disposition "inline; filename= sosa-om.ttl"
    Header set Content-Location "http://www.w3.org/ns/sosa/om.ttl" env=REDIRECT_redirect
</Files>

<Files ~ "oboe\.rdf$">
    Header set Content-Type "application/rdf+xml"
    Header set Content-Disposition "inline; filename= sosa-oboe.rdf"
    Header set Content-Location "http://www.w3.org/ns/sosa/oboe.rdf" env=REDIRECT_redirect
</Files>

<Files ~ "oboe\.ttl$">
    Header set Content-Type "text/turtle"
    Header set Content-Disposition "inline; filename= sosa-oboe.ttl"
    Header set Content-Location "http://www.w3.org/ns/sosa/oboe.ttl" env=REDIRECT_redirect
</Files>


######################################################################
# Serve request to the directory based on the Accept HTTP header
#
# Given a request to /ns/sosa/:
# If Accept contains application/rdf+xml, serve the RDF/XML file.
# If Accept contains text/turtle, serve the Turtle file.
# Redirect to the specification that defines the ontologies with a
# 303 (See Other) code otherwise. A 303 is used because the request is
# for the SOSA ontology, not for the specification that defines it
#
# Note that there is no proper way to support the "q" parameter in
# Accept headers in .htaccess files.
######################################################################
RewriteCond  %{REQUEST_URI}  /ns/sosa/$
RewriteCond %{HTTP_ACCEPT} !(application/rdf\+xml|text/turtle)
RewriteRule  ^(.*)$  https://www.w3.org/TR/vocab-ssn/ [R=303,env=redirect:1]

RewriteCond  %{REQUEST_URI}  /ns/sosa/$
RewriteCond %{HTTP_ACCEPT} application/rdf\+xml
RewriteRule  ^(.*)$  /ns/sosa/sosa.rdf [env=redirect:1]

RewriteCond  %{REQUEST_URI}  /ns/sosa/$
RewriteCond %{HTTP_ACCEPT} text/turtle
RewriteRule  ^(.*)$  /ns/sosa/sosa.ttl [env=redirect:1]


######################################################################
# Redirect requests to individual ontology terms
#
# Redirect depends on the Accept HTTP header. Possible targets are the
# RDF/XML version of the ontology, the Turtle version of the ontology,
# or the right fragment in the specification.
#
# Redirection done with a 303 (See Other) code, see above for details.
######################################################################
RewriteCond  %{REQUEST_URI}  /ns/sosa/(ActuatableProperty|Actuation|Actuator|FeatureOfInterest|ObservableProperty|Observation|Platform|Procedure|Repeatability|Result|Sample|Sampler|Sampling|Sensor|actsOnProperty|madeByActuator|hasFeatureOfInterest|hasResult|hasResultingSample|hasSample|hosts|isActedOnBy|isFeatureOfInterestOf|isHostedBy|isObservedBy|isResultOf|isSampleOf|isSamplingResultOf|madeActuation|madeBySampler|madeBySensor|madeObservation|madeSampling|observedProperty|observes|phenomenonTime|usedProcedure|hasSimpleResult|hasResultTime)
RewriteCond %{HTTP_ACCEPT} !(application/rdf\+xml|text/turtle)
RewriteRule  ^(.*)$  https://www.w3.org/TR/vocab-ssn/#SOSA$1 [R=303,NE,env=html:1]

RewriteCond  %{REQUEST_URI}  /ns/sosa/(ActuatableProperty|Actuation|Actuator|FeatureOfInterest|ObservableProperty|Observation|Platform|Procedure|Repeatability|Result|Sample|Sampler|Sampling|Sensor|actsOnProperty|madeByActuator|hasFeatureOfInterest|hasResult|hasResultingSample|hasSample|hosts|isActedOnBy|isFeatureOfInterestOf|isHostedBy|isObservedBy|isResultOf|isSampleOf|isSamplingResultOf|madeActuation|madeBySampler|madeBySensor|madeObservation|madeSampling|observedProperty|observes|phenomenonTime|usedProcedure|hasSimpleResult|hasResultTime)
RewriteCond %{HTTP_ACCEPT} application/rdf\+xml
RewriteRule  ^(.*)$  /ns/sosa/sosa.rdf [R=303,env=rdf:1]
Header always set Content-Type "application/rdf+xml" env=rdf

RewriteCond  %{REQUEST_URI}  /ns/sosa/(ActuatableProperty|Actuation|Actuator|FeatureOfInterest|ObservableProperty|Observation|Platform|Procedure|Repeatability|Result|Sample|Sampler|Sampling|Sensor|actsOnProperty|madeByActuator|hasFeatureOfInterest|hasResult|hasResultingSample|hasSample|hosts|isActedOnBy|isFeatureOfInterestOf|isHostedBy|isObservedBy|isResultOf|isSampleOf|isSamplingResultOf|madeActuation|madeBySampler|madeBySensor|madeObservation|madeSampling|observedProperty|observes|phenomenonTime|usedProcedure|hasSimpleResult|hasResultTime)
RewriteCond %{HTTP_ACCEPT} text/turtle
RewriteRule  ^(.*)$  /ns/sosa/sosa.ttl [R=303,env=ttl:1]
Header always set Content-Type "text/turtle" env=ttl


######################################################################
# SOSA to O&M mapping - Apply the same logic as for the SOSA ontology
######################################################################
RewriteCond  %{REQUEST_URI}  /ns/sosa/om$
RewriteCond %{HTTP_ACCEPT} !(application/rdf\+xml|text/html)
RewriteRule  ^(.*)$  /ns/sosa/om.ttl [env=redirect:1]

RewriteCond  %{REQUEST_URI}  /ns/sosa/om$
RewriteCond %{HTTP_ACCEPT} application/rdf\+xml
RewriteRule  ^(.*)$  /ns/sosa/om.rdf [env=redirect:1]

RewriteCond  %{REQUEST_URI}  /ns/sosa/om$
RewriteCond %{HTTP_ACCEPT} text/html
RewriteRule  ^(.*)$  https://www.w3.org/TR/vocab-ssn/#OM_Alignment [R=303,NE,env=redirect:1]


######################################################################
# SOSA to OBOE mapping - Apply the same logic as for the SOSA ontology
######################################################################
RewriteCond  %{REQUEST_URI}  /ns/sosa/oboe$
RewriteCond %{HTTP_ACCEPT} !(application/rdf\+xml|text/html)
RewriteRule  ^(.*)$  /ns/sosa/oboe.ttl [env=redirect:1]

RewriteCond  %{REQUEST_URI}  /ns/sosa/oboe$
RewriteCond %{HTTP_ACCEPT} application/rdf\+xml
RewriteRule  ^(.*)$  /ns/sosa/oboe.rdf [env=redirect:1]

RewriteCond  %{REQUEST_URI}  /ns/sosa/oboe$
RewriteCond %{HTTP_ACCEPT} text/html
RewriteRule  ^(.*)$  https://www.w3.org/TR/vocab-ssn/#OBOE_Alignment [R=303,NE,env=redirect:1]


######################################################################
# Rewrite rules vary the response based on the Accept HTTP header, so
# make sure we tell network caches about that.
######################################################################
Header always merge Vary "Accept" env=redirect
Header always merge Vary "Accept" env=rdf
Header always merge Vary "Accept" env=ttl
Header always merge Vary "Accept" env=html